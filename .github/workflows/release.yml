name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Update version in shared/pkg/version.go
        run: |
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF_NAME#v}
          sed -i "s/Version = \".*\"/Version = \"$VERSION\"/" shared/pkg/version.go
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          # Initialize workspace as go.work is gitignored
          go work init ./client ./server ./shared
          # Download dependencies for each module
          for dir in client server shared; do
            echo "Installing dependencies for $dir..."
            (cd $dir && go mod download)
          done

      - name: Run Build Script
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: build/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}